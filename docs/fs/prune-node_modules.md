# 清洁 node_modules 中无用文件

node_modules 里面有很多文件根本用不到，但是在安装时候依然会添加进来。

```ts
export const needRemoveFile: Set<string> = new Set<string>([
  "Jenkinsfile",
  "Makefile",
  "Gulpfile.js",
  "Gruntfile.js",
  "gulpfile.js",
  ".DS_Store",
  ".tern-project",
  ".gitattributes",
  ".editorconfig",
  ".eslintrc",
  "eslint",
  ".eslintrc.js",
  ".eslintrc.json",
  ".eslintrc.yml",
  ".eslintignore",
  ".stylelintrc",
  "stylelint.config.js",
  ".stylelintrc.json",
  ".stylelintrc.yaml",
  ".stylelintrc.yml",
  ".stylelintrc.js",
  ".htmllintrc",
  "htmllint.js",
  ".lint",
  ".npmrc",
  ".npmignore",
  ".jshintrc",
  ".flowconfig",
  ".documentup.json",
  ".yarn-metadata.json",
  ".travis.yml",
  "appveyor.yml",
  ".gitlab-ci.yml",
  "circle.yml",
  ".coveralls.yml",
  "CHANGES",
  "changelog",
  "LICENSE.txt",
  "LICENSE",
  "LICENSE-MIT",
  "LICENSE.BSD",
  "license",
  "LICENCE.txt",
  "LICENCE",
  "LICENCE-MIT",
  "LICENCE.BSD",
  "licence",
  "AUTHORS",
  "CONTRIBUTORS",
  ".yarn-integrity",
  ".yarnclean",
  "_config.yml",
  ".babelrc",
  ".yo-rc.json",
  "jest.config.js",
  "karma.conf.js",
  "wallaby.js",
  "wallaby.conf.js",
  ".prettierrc",
  ".prettierrc.yml",
  ".prettierrc.toml",
  ".prettierrc.js",
  ".prettierrc.json",
  "prettier.config.js",
  ".appveyor.yml",
  "tsconfig.json",
  "tslint.json",
])

export const needRemoveDir: Set<string> = new Set<string>([
  "__tests__",
  "test",
  "tests",
  "powered-test",
  "docs",
  "doc",
  ".idea",
  ".vscode",
  "website",
  "images",
  "assets",
  "example",
  "examples",
  "coverage",
  ".nyc_output",
  ".circleci",
  ".github",
])
 
export const needRemoveExt: Set<string> = new Set([
  ".markdown",
  ".md",
  ".mkd",
  ".ts",
  ".jst",
  ".coffee",
  ".tgz",
  ".swp",
])
```


```ts
import { readdirSync, rm, statSync, unlinkSync } from 'node:fs'
import { join } from 'node:path'
import { invariant } from '../utils/invariant'
import { needRemoveDir, needRemoveExt, needRemoveFile } from './const'

export const findNodeModulesThenPrune = async (path: string) => {
  invariant(!path.endsWith('node_modules'), 'remove directory must is "node_modules"')
  const absolutePath = path.startsWith('/') ? path : join(__dirname, path)
  invariant(!statSync(absolutePath).isDirectory(), 'current path is not directory')

  let fileCount = 0
  let dirCount = 0
  console.time('purne node_modules')

  const prune = (dir: string) => {
    const files = readdirSync(dir)
    files.forEach(file => {
      const fullPath: string = join(dir, file)
      if (statSync(fullPath).isDirectory()) {
        if (needRemoveDir.has(file)) {
          dirCount++
          rm(fullPath, { force: true, recursive: true }, () => {})
        } else {
          prune(fullPath)
        }
        return
      }
      if (needRemoveFile.has(file)) {
        fileCount++
        unlinkSync(fullPath)
        return
      }
      if (fullPath.indexOf('.') > 0) {
        const splitName = fullPath.split('.');
        if (needRemoveExt.has(`.${splitName[splitName.length - 1]}`)) {
          fileCount++
          unlinkSync(fullPath)
        }
      }
    })
  }
  
  prune(absolutePath)
  console.log(`remove file count ${fileCount} and remove dir count ${dirCount}, use time `)
  console.timeEnd('purne node_modules')
}
```